---
title: "3. Generating EU NUTS MAP"
output: rmarkdown::html_vignette
vignette: >
  %\VignetteIndexEntry{Generating GLOBIOM eu nuts map}
  %\VignetteEngine{knitr::rmarkdown}
  %\VignetteEncoding{UTF-8}
---

```{r, include = FALSE}
knitr::opts_chunk$set(
  collapse = TRUE,
  comment = "#>"
)
```

## Introduction

For some projects we want to create a map of EU NUTS level results produced by GLOBIOM. This vignette provides several examples on how to do this. The EU NUTS map is part of the package and can be loaded using buildin commands (see below). The package also includes data on potentially disappeared fraction of global species (PDF/m2) at the EU Nuts region (`eu_nuts_pdf`) from [Di Fulvio et al. (2019)](https://www.sciencedirect.com/science/article/pii/S0048969718333941?via%3Dihub), which will be used in the example.


## Preparing the data

We use the [sf package](https://cran.r-project.org/web/packages/sf/index.html) for most of the vector (e.g. polygon) processing so it needs to be loaded first. The package can be easily combined with [ggplot2](https://cran.r-project.org/web/packages/ggplot2/index.html) the core plotting package in R.

Before we can create the map we need to: (1) load the EU NUTS polygons (part of the package); (2) laod the example data (part of the package) and (3) connect the the two.


```{r message=FALSE, warning=FALSE, include=TRUE}
library(rglobiom)
library(ggplot2)
library(sf)
library(dplyr)

# Load the EU NUTS polygons
eu_nuts_poly <- st_read(system.file("shp", "NUTS2_revised.shp", package = "rglobiom"))

# Load the test data into the global environment (i.e. it will display in RStudio so you can click on it)
list2env(eu_nuts_pdf ,.GlobalEnv)

# Join the data. The variable names in the polygon file and the data file are the same (NUTS2) so they are automatically linked. Note that the order is important because otherwise the polygon format will be lost (do not ask me why).
eu_nuts <- left_join(eu_nuts_poly, eu_nuts_pdf)

```


## Create a simple map for one period and one variable

```{r message=FALSE, warning=FALSE, include=TRUE}
# Prepare data. We Select only the year 2050
df <- eu_nuts %>%
  filter(year == 2050)

# Create the map. Note that we plot the map twice (2xgeom_sf). The first call ensures that the full map is depicted (with background color red). As we used a filter, we removed polygons for which data was not available. The red areas show the polygons for which no example data is available. To remove it use another color (e.g. "grey50") or make it transparent ("transparent"). 
ggplot() +
  geom_sf(data = eu_nuts_poly, colour = "grey30", fill = "red") +
  geom_sf(data = df, colour = "grey30", aes(fill = value)) +
  scale_fill_gradientn(colours = terrain.colors(10)) +
  labs(fill = "", x = "", y = "", title = "Potentially Disappeared Fraction of global species for 2050") +
  theme(panel.grid.major = element_blank(), 
        panel.grid.minor = element_blank(), 
        panel.background = element_blank(),
        panel.border = element_rect(colour = "black", fill = "transparent"), 
       plot.title = element_text(hjust = 0.5))
```


## Create a simple map for multiple periods and one variable

In this example we create multiple maps that show the change in PDF over time and in space. As we are increasing the number of maps, we first 'simplify' the polygons to speed up the processing time. The EU NUTS polygon is quite detailed (i.e. capturing complex border patterns), which consume a lot of memory when plotting. This information is not needed for exploratory mapping. 


```{r,  message=FALSE, warning=FALSE, include=TRUE}

# Simplify the map
eu_nuts_poly_s <- st_simplify(eu_nuts_poly, dTolerance = 5000)

# Remove NA values
df2 <- left_join(eu_nuts_poly_s, eu_nuts_pdf) %>%
  filter(!is.na(value))

# plot
ggplot() +
  geom_sf(data = eu_nuts_poly_s, colour = "grey30", fill = "red") +
  geom_sf(data = df2, colour = "grey30", aes(fill = value)) +
  scale_fill_gradientn(colours = terrain.colors(10)) +
  labs(fill = "", x = "", y = "", title = "Potentially Disappeared Fraction of global species for 2010-2050") +
  facet_wrap(~year) +
  theme(panel.grid.major = element_blank(), 
        panel.grid.minor = element_blank(), 
        panel.background = element_blank(),
        panel.border = element_rect(colour = "black", fill = "transparent"), 
        plot.title = element_text(hjust = 0.5),
        strip.background = element_rect(fill = "transparent"),
        legend.position = "bottom")

```

